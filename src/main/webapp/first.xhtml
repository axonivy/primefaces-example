<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
  xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:p="http://primefaces.org/ui">

  <h:head>
    <title>First page</title>
  </h:head>
  <h:body>
    <h1>First Page</h1>
  
    <h:form id="form">
      <p:commandButton id="ajax" action="#{mainBean.redirect()}"
        value="Redirect to second page (ajax loader)" update="form" />
      <br />

      <p:commandButton action="#{mainBean.doAction()}" value="Action" update="form"/>
      <br />
      <p:outputLabel value="#{mainBean.actionCount}"/>
    </h:form>

    <p:ajaxStatus id="ajaxLoadingStatus" delay="150" onstart="ajaxStatusStartHandler()" oncomplete="ajaxStatusCompleteHandler()">
      <p:dialog id="ajaxStatusDialog" style="background-color:transparent" widgetVar="ajaxStatusDialog" modal="true" draggable="false"
        closable="false" resizable="false" width="100" height="100" showHeader="false">
        <div>
          <h5>Loading...</h5>
        </div>
      </p:dialog>
    </p:ajaxStatus>
    
    <script type="text/javascript">
      var jqueryXhr;
    
      $(document).on('pfAjaxComplete', function(event, xhr, options) {
        jqueryXhr = xhr;
      });
    
    function ajaxStatusStartHandler() {
      PF('ajaxStatusDialog').show();
    }
    
    function ajaxStatusCompleteHandler() {
      //do not hide progress bar in case a redirect is now coming, so that till the redirect is done the progress bar is blocking the UI
      if (jqueryXhr == null || jqueryXhr.readyState != 4 || !jqueryXhr.responseText.startsWith('&lt;partial-response&gt;&lt;redirect url="')) {
        PF('ajaxStatusDialog').hide();
      }
    }
   </script>  
    
    <!--  Exception Handler for any other Exception -->
    <p:ajaxExceptionHandler update="exceptionDialog" onexception="PF('exceptionDialog').show();"/>

    <!-- Error Dialog to show Exceptions -->
    <p:dialog id="exceptionDialog" header="Exception '#{pfExceptionHandler.type}' occured!" widgetVar="exceptionDialog" height="500px">
      Message: #{pfExceptionHandler.message} <br/>
      <p:button href="index.xhtml" value="Back to Main page!" />
    </p:dialog>
    
  </h:body>
</html>